# Nginx 설정 - 3-Tier MSA 배포용 API Gateway
# Tier 1: Nginx (Load Balancer/API Gateway)
# Tier 2: Tomcat (Application Servers)
# Tier 3: MariaDB (Database)

# EC2-1: 일반 서비스들 (User, Product, Order)
upstream general_services {
    server 10.0.1.10:8080;  # User Service
    server 10.0.1.10:8081;  # Product Service  
    server 10.0.1.10:8083;  # Order Service
    keepalive 32;
}

# EC2-2: 쿠폰 전용 서버 (선착순 트래픽 테스트용)
upstream coupon_service {
    server 10.0.1.20:8082;  # Coupon Service (독립 서버)
    keepalive 32;
}

# 개발환경용 단일 서버 설정 (기존 호환성)
upstream user_service_dev {
    server 127.0.0.1:8080;
    keepalive 32;
}

upstream product_service_dev {
    server 127.0.0.1:8081;
    keepalive 32;
}

upstream coupon_service_dev {
    server 127.0.0.1:8082;
    keepalive 32;
}

upstream order_service_dev {
    server 127.0.0.1:8083;
    keepalive 32;
}

# 환경별 upstream 선택을 위한 map
map $server_name $use_multi_tier {
    default 0;  # 개발환경 (단일 서버)
    "~*prod" 1; # 운영환경 (3-tier)
    "~*staging" 1; # 스테이징환경 (3-tier)
}

server {
    listen 80;
    server_name _;
    
    # 로그 설정
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;
    
    # 기본 설정
    client_max_body_size 10M;
    proxy_connect_timeout 5s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
    
    # Health Check (ALB용)
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
    
    # 공통 프록시 헤더 설정
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    
    # === 3-TIER 운영환경 라우팅 ===
    
    # 쿠폰 서비스 (전용 서버 - EC2-2) - 선착순 트래픽 테스트용
    location /api/v1/coupons/ {
        if ($use_multi_tier = 1) {
            proxy_pass http://coupon_service;
            break;
        }
        proxy_pass http://coupon_service_dev;
        
        # 쿠폰 선착순 발급을 위한 추가 설정
        proxy_buffering off;
        proxy_cache off;
    }
    
    # 상품 서비스 (일반 서버 - EC2-1)
    location /api/v1/products/ {
        if ($use_multi_tier = 1) {
            proxy_pass http://general_services;
            break;
        }
        proxy_pass http://product_service_dev;
    }
    
    # 주문 서비스 (일반 서버 - EC2-1)  
    location /api/v1/orders/ {
        if ($use_multi_tier = 1) {
            proxy_pass http://general_services;
            break;
        }
        proxy_pass http://order_service_dev;
    }
    
    # 사용자 서비스 (일반 서버 - EC2-1, Default)
    location / {
        if ($use_multi_tier = 1) {
            proxy_pass http://general_services;
            break;
        }
        proxy_pass http://user_service_dev;
    }
}

# HTTPS 설정 (운영환경용)
server {
    listen 443 ssl http2;
    server_name your-domain.com;
    
    # SSL 인증서 설정 (Let's Encrypt 또는 AWS Certificate Manager)
    ssl_certificate /etc/ssl/certs/your-domain.crt;
    ssl_certificate_key /etc/ssl/private/your-domain.key;
    
    # SSL 보안 설정
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    
    # HTTP와 동일한 location 설정
    include /etc/nginx/conf.d/common-locations.conf;
}